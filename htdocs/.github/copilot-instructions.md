# Copilot Instructions for `crm`

- **Stack**: PHP 8.2, FastRoute, Symfony HttpFoundation, PSR-4 autoload. Entry bootstraps in [bootstrap/app.php](bootstrap/app.php#L1-L42); `public/index.php` should include it and hand off a `Request` to `App\Kernel`.
- **Routing**: All HTTP routes live in [app/Kernel.php](app/Kernel.php#L20-L369) and are cached to `storage/cache/fastroute.cache.php`. Add routes via `registerRoute()` when avoiding duplicates (see [app/Kernel.php](app/Kernel.php#L426-L518)) and remember CSRF exceptions for POST/PUT/PATCH/DELETE are whitelisted in [`$csrfExcept`](app/Kernel.php#L27-L41).
- **Modules**: Kernel maps controllers for finance, CRM, marketing (lists, automations, consent center), agenda, chat, email inbox, backups, and WhatsApp (official + alt gateway). Explore controllers under [app/Controllers](app/Controllers) to mirror patterns.
- **Config & permissions**: Runtime config in [config/app.php](config/app.php), [config/marketing.php](config/marketing.php), and profiles/ACL in [config/permissions.php](config/permissions.php) (defaults applied on user approval). Respect these instead of hardcoding roles or feature flags.
- **Marketing imports**: UI expects CSV per [public/samples/marketing_contacts_template.csv](public/samples/marketing_contacts_template.csv). Imports log to `import_logs` and update consent/attributes. Duplicate handling and reporting are covered in [README](README.md#L8-L87).
- **Campaign worker**: Generate queue with `php scripts/marketing/enqueue_campaign_messages.php --limit=200`, then deliver via `php scripts/marketing/deliver_mail_queue.php --worker=mailer01 --batch=25 --sleep=10 --account-id=1` (see [README](README.md#L22-L67)). Logs live in `storage/logs/mail_worker.log`; structured events in `mail_delivery_logs`.
- **WhatsApp official**: Entities `whatsapp_contacts/threads/messages`; webhook endpoints are CSRF-exempt (`/whatsapp/webhook`). Configure tokens in UI; testing payload example in [README](README.md#L129-L168). Copilot suggestions use `/whatsapp/copilot-*` endpoints.
- **WhatsApp alt gateway**: Service docs in [services/whatsapp-web-gateway/README.md](services/whatsapp-web-gateway/README.md#L1-L5); CRM can trigger manual history sync via `POST /history-sync` with `X-Gateway-Token`.
- **Chat module**: Proposed data model and WS flow are documented in [docs/chat-architecture.md](docs/chat-architecture.md). Current HTTP endpoints are under `/chat/*` in [app/Kernel.php](app/Kernel.php#L173-L217); CSRF is bypassed for external-thread endpoints.
- **Auth/session**: `SessionAuthService` + `AuthGuard` gate controllers. Controllers must return `Symfony\Component\HttpFoundation\Response`; missing responses will throw (see [app/Kernel.php](app/Kernel.php#L480-L501)).
- **CSRF**: `CsrfTokenManager::validate()` runs for mutating verbs except paths in `$csrfExcept`. Include tokens in forms or add explicit exception only when necessary.
- **Environment**: Copy `.env.example` to `.env`; `APP_FORCE_HTTPS` and `APP_DEBUG` read in bootstrap. Sessions set `SameSite=Lax` and respect `X-Forwarded-Proto`.
- **Build/run**: `composer install`; run migrations via `php scripts/migrate.php`; serve locally with `php -S localhost:8080 -t public` (see [README](README.md#L92-L116)).
- **Tests**: Marketing import test at [tests/Marketing/MarketingContactImportServiceTest.php](tests/Marketing/MarketingContactImportServiceTest.php). Execute with `php tests/Marketing/MarketingContactImportServiceTest.php` (no separate runner).
- **Data outputs & backups**: Backup manager routes under `/backup-manager/*`; emails sync alerts can be generated from logs with `php scripts/email/generate_mailbox_sync_alert.php` after running sync (see [README](README.md#L204-L234)).
- **Docs worth reading**: roadmap/operational docs in [docs](docs); marketing consent flows in [README](README.md#L136-L195); partner indicators in [README](README.md#L196-L230).
- **Patterns when adding code**: Keep controllers thin; defer business logic to services in [app/Services](app/Services) and repositories in [app/Repositories](app/Repositories). Use config helpers instead of `$_ENV`. Reuse existing logging paths under `storage/logs`.
- **Front-end**: Assets live in [assets](assets) and [resources/views](resources/views); theme presets use “futurist” palette referenced in README. Keep UI responsive and match existing dark branding (e.g., consent center at `/preferences/{token}`).
- **Operational safety**: Production expects webroot `public/`, `storage/` shielded. Avoid adding debug output; prefer structured logs as existing workers do.

If any section feels incomplete or you need more conventions captured, tell me which area to expand (e.g., finance imports, chat WS runtime, marketing automations).